#!/bin/bash

# Get git diff (both staged and unstaged)
DIFF=$(git diff HEAD)

if [ -z "$DIFF" ]; then
    echo "No changes to commit."
    exit 0
fi

# Feed diff to Claude and get commit message
echo "Analyzing changes with Claude..."
COMMIT_MSG=$(echo "$DIFF" | claude "Based on this git diff, generate a concise commit message (1-2 lines). Only output the commit message itself, nothing else. Do not include any attribution like 'Generated by Claude' or 'Co-authored by'.")

if [ -z "$COMMIT_MSG" ]; then
    echo "Failed to generate commit message."
    exit 1
fi

# Stage all files
echo "Staging all files..."
git add -A

# Show the generated commit message
echo ""
echo "Generated commit message:"
echo "------------------------"
echo "$COMMIT_MSG"
echo "------------------------"
echo ""

# Prompt user to commit
read -p "Commit with this message? (y/n): " -n 1 -r
echo ""

if [[ $REPLY =~ ^[Yy]$ ]]; then
    git commit -m "$COMMIT_MSG"
    echo "Committed successfully!"
else
    echo "Commit cancelled. Changes remain staged."
fi
